---
title: "Exploration"
output: html_document
---

## Housekeeping
```{r}
library(ggplot2)
source("utility.R")
```

## Read in Data Sample
```{r}
day1 <- "Webscope/R6/ydata-fp-td-clicks-v1_0.20090501.gz"
max_lines <- scan(text=system(paste("zcat <", day1, "| wc -l"), intern=TRUE), n=1)

raw_dat <- samplefile(day1, .5)
proc_line(raw_dat, "str_dat")
num_col <- max(count.fields("str_dat", sep=" "))

max_fields <- which(count.fields("str_dat", sep=" ")==max(count.fields("str_dat", sep=" ")))

dat <- read.table("str_dat", sep=" ", fill=TRUE, comment.char="",
                  nrows=length(raw_dat), header=FALSE, col.names=print_header(),
                  colClasses=c("numeric", "factor", "factor", 
                               "numeric", "numeric", "numeric", "numeric", "numeric", "numeric",
                               rep(c("factor", "numeric", "numeric", "numeric",
                                     "numeric", "numeric", "numeric"), 22), "factor", "numeric",
                               "factor", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric"))
names(dat) <- print_header()
```

## Initial Exploration of Conjoint Characteristics

```{r}
summary(dat)
summary(dat$a1_id)
plot(dat[, 4:8])

pc <- princomp(dat[, 4:8])
plot(pc)

pc <- prcomp(dat[, 4:8])
comp <- data.frame(pc$x[,1:4])
plot(comp)
library(rgl)
plot3d(comp$PC1, comp$PC2, comp$PC3)
```

You can also embed plots, for example:

```{r}
library(DBI)
con <- dbConnect(RSQLite::SQLite(), "full_copy.db")
res <- dbSendQuery(con, "SELECT * FROM article WHERE articleID=109417")
dbFetch(res)

res <- dbSendQuery(con, "SELECT datetime, COUNT(datetime) FROM event GROUP BY datetime")
times <- dbFetch(res, n=-1)
names(times) <- c('datetime', 'count')
times$datetime <- as.POSIXct(times$datetime)
ggplot(times, aes(datetime, count)) + geom_line()

res <- dbSendQuery(con, "SELECT datetime, AVG(click) FROM event GROUP BY datetime")
ctr <- dbFetch(res, n=-1)
names(ctr) <- c('datetime', 'ctr')
ctr$datetime <- as.POSIXct(ctr$datetime)
ggplot(ctr, aes(datetime, ctr)) + geom_line()

# articles with best CTRs
res <- dbSendQuery(con, "SELECT articleID, AVG(click) FROM event LEFT JOIN article ON event.displayed=article.articleID GROUP BY articleID ORDER BY AVG(click) DESC")
best_articles <- dbFetch(res, n=-1)

# favorite article by cluster
res <- dbSendQuery(con, "SELECT cluster, articleID, AVG(click) from event LEFT JOIN article ON event.displayed=article.articleID LEFT JOIN user ON event.userID=user.userID GROUP BY cluster")
cluster_favorites <- dbFetch(res, n=-1)

# cluster clickthrough rates
res <- dbSendQuery(con, "SELECT cluster, AVG(click), datetime from event LEFT JOIN user ON event.userID=user.userID GROUP BY cluster, datetime")
ctr_by_cluster <- dbFetch(res, n=-1)
names(ctr_by_cluster) <- c('cluster', 'ctr', 'datetime')
ctr_by_cluster$datetime <- as.POSIXct(ctr_by_cluster$datetime)
ggplot(ctr_by_cluster, aes(x=datetime, y=ctr, colour=cluster)) + geom_line() + stat_smooth(method='loess', formula=y ~ x, size=1)

# best arm per time period
res <- dbSendQuery(con, "SELECT MAX(ctr), datetime, articleID from (SELECT AVG(click) as ctr, datetime, articleID from event LEFT JOIN article ON event.displayed=article.articleID GROUP BY datetime, articleID) GROUP BY datetime")
arm_ctr <- dbFetch(res, n=-1)
names(arm_ctr)[1] <- c('ctr')
arm_ctr$datetime <- as.POSIXct(arm_ctr$datetime)
ggplot(arm_ctr, aes(x=datetime, y=ctr, fill=as.factor(articleID))) + geom_bar(stat='Identity')

# best arm per time period by cluster
res <- dbSendQuery(con, "SELECT MAX(ctr), datetime, articleID, cluster from (SELECT AVG(click) as ctr, datetime, articleID, cluster from event LEFT JOIN article ON event.displayed=article.articleID LEFT JOIN user ON event.userID=user.userID GROUP BY datetime, articleID, cluster) GROUP BY datetime, cluster")
arm_ctr_by_cluster <- dbFetch(res, n=-1)
names(arm_ctr_by_cluster)[1] <- c('ctr')
arm_ctr_by_cluster$datetime <- as.POSIXct(arm_ctr_by_cluster$datetime)
ggplot(arm_ctr_by_cluster, aes(x=datetime, y=ctr, fill=as.factor(articleID))) + geom_bar(stat='Identity') + facet_wrap(~cluster)

# top 5 arms per cluster
top_arms_by_cluster <- data.frame()
for (i in 2:6) {
  res <- dbSendQuery(con, paste("SELECT AVG(click) as ctr, articleID, cluster from event LEFT JOIN article ON event.displayed=article.articleID LEFT JOIN user ON event.userID=user.userID WHERE cluster=", i, "GROUP BY articleID ORDER BY ctr DESC LIMIT 5"))
  top_arms_by_cluster <- rbind(top_arms_by_cluster, dbFetch(res, n=-1))
}
ggplot(top_arms_by_cluster, aes(x=articleID, y=ctr, fill=as.factor(articleID))) + geom_bar(stat='Identity') + facet_wrap(~cluster)

# get ctr for specific article
res <- dbSendQuery(con, 'SELECT AVG(click) FROM event LEFT JOIN user ON event.userID=user.userID WHERE event.displayed=109453 AND user.cluster=2')
dbFetch(res, n=-1)

dbDisconnect(con)
```

```{r}
library(zoo)

test_results <- 'test_results.gz'
res <- read.table(test_results, sep='\t', header=TRUE)
res$policy <- as.factor(res$policy)
res$reward.avg <- rollmean(res$reward, 100, fill=list(NA, NA, NA))
res$regret.cum <- ave(res$regret, res$policy, FUN=cumsum)
ggplot(res, aes(x=T, y=regret.cum, colour=policy)) + geom_line() + stat_smooth(method='loess', formula=y~x)
```

